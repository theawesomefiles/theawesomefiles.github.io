<html>
<head>
<link rel="stylesheet" href="style.css"/>
<script>
function Get(yourUrl){
    var Httpreq = new XMLHttpRequest(); // a new request
    Httpreq.open("GET",yourUrl,false);
    Httpreq.send(null);
    return Httpreq.responseText;          
}

function stringFromObject(obj) {
	var ret = "";
	for(var property in obj) {
		if(obj.hasOwnProperty(property) && property[0] === property[0].toUpperCase()) {
			ret += "<td valign='top'>" + obj[property] + "</td>";
		}
	}
	if(obj.IslandTime == null) {
		ret += "<td valign='top'></td>";
	}
	return ret;
}

function* iter(o) {
    var keys = Object.keys(o);
    for (var i=0; i<keys.length; i++) {
		yield {key: keys[i], value: o[keys[i]]};
    }
}

function filterItem(obj,params,month,hour) {
	if(params['show'] == 'all') {
		return true;
	}

	var passedDateValidation = false;
	if(obj.datetime != null) {
		if(obj.datetime == '*') {
			passedDateValidation = true;
		}
		else {
			obj.datetime[Symbol.iterator] = iter.bind(null, obj.datetime);

			for(var dateTimeEntry of obj.datetime) {
				var buffer = dateTimeEntry.key.split('-');
				var firstMonth = parseInt(buffer[0]);
				var lastMonth = parseInt(buffer[1]);
				var currentMonth = month;
				if(lastMonth < firstMonth) {
					lastMonth += 12;
					if(currentMonth < firstMonth) {
						currentMonth += 12;
					}
				}
			
				if(currentMonth >= firstMonth && currentMonth <= lastMonth) {
					timeList = dateTimeEntry.value;
					for(var i = 0; i < timeList.length; ++i) {
						buffer = timeList[i].split('-');
						var firstHour = parseInt(buffer[0]);
						var lastHour = parseInt(buffer[1]);
						var currentHour = hour;
						
						if(lastHour < firstHour) {
							lastHour += 24;
							if(currentHour < firstHour) {
								currentHour += 24;
							}
						}

						if(currentHour >= firstHour && currentHour < lastHour) {
							passedDateValidation = true;
						}
					}
				}
			}
		}
	}
	
	var passedIslandTimeValidation = false;
	if(obj.islandhours != null) {
		for(var hourEntry of obj.islandhours) {
			var buffer = hourEntry.split('-');
			var firstHour = parseInt(buffer[0]);
			var lastHour = parseInt(buffer[1]);
			var currentHour = hour;
			
			if(lastHour < firstHour) {
				lastHour += 24;
				if(currentHour < firstHour) {
					currentHour += 24;
				}
			}

			if(currentHour >= firstHour && currentHour < lastHour) {
				passedIslandTimeValidation = true;
			}
		}
	}
		
	var showIsland = params['island'];
	if(showIsland == 'only') {
		if(obj.IslandTime == null || !passedIslandTimeValidation) {
			return false;
		}
	} else if (showIsland == 'false') {
		if(!passedDateValidation) {
			return false;
		}
	}
	return passedIslandTimeValidation || passedDateValidation;
}

function compareItems(x, y, sortField, sortOrder) {
	var comparisonResult = x[sortField] < y[sortField] ? -1 : (x[sortField] > y[sortField] ? 1 : 0);
	if (comparisonResult == 0) {
		comparisonResult = x.Name < y.Name ? -1 : 1;
	}

	if(sortOrder == 'desc') {
		comparisonResult *= -1;
	}

	return comparisonResult;
}

function sortItems(obj,params) {
	var sortField = params['sf'];
	var sortOrder = params['so'];
	if(sortField == null) {
		sortField = 'Value';
	}
	if(sortOrder == null) {
		if(sortField == 'Value') {
			sortOrder = 'desc';
		} else {
			sortOrder = 'asc';
		}
	}
	obj.sort((x, y) => compareItems(x, y, sortField, sortOrder));
	return obj;
}

var json_obj;
var searchParams;

function process() {
	json_obj = sortItems(json_obj,searchParams);

	var resultHTML = "";
	resultHTML += "<table><tbody>";
	resultHTML += "<tr><td class='header'>Name</td><td class='header'>Value</td><td class='header'>Rarity</td><td class='header'>Location</td><td class='header'>Date,Time (" + new Date(new Date().getTime()).toLocaleTimeString() + ")</td><td class='header'>Island Time</td>";
	var month = new Date().getMonth() + 1;
	var hour = new Date().getHours();
	for(var i = 0; i < json_obj.length; i++) {
		var dataObj = json_obj[i];
		if(filterItem(dataObj,searchParams,month,hour)) {
			resultHTML += "<tr>" 
				+ stringFromObject(dataObj)
				+"</tr>";
		}
	}
	resultHTML += "</tbody></table>";
	document.getElementById('results').innerHTML = resultHTML;
	var interval = (5 - new Date().getSeconds() % 5) * 1000 + new Date().getMilliseconds();
	if(interval > 5000) {
		interval = 5000;
	}
	setTimeout(process, interval);
}

function load() {
	json_obj = JSON.parse(Get("bugs.json"));
	var urlParams = new URLSearchParams(location.search.slice(1));
	searchParams = {};
	for(var searchKey of urlParams) {
		searchParams[searchKey[0]] = searchKey[1];
	}
	process();
}
</script>
</head>
<body onload="load()">
<div id="results" />
</body>
</html>
